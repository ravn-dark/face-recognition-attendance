{% extends "base.html" %}

{% block title %}Take Attendance - Automated Attendance System{% endblock %}

{% block extra_css %}
<style>
    .attendance-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .attendance-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .attendance-header h1 {
        color: #212529;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .attendance-header p {
        color: #6c757d;
    }
    
    .camera-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .camera-container {
        position: relative;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .camera-feed {
        width: 100%;
        height: auto;
        display: block;
    }
    
    .camera-placeholder {
        width: 100%;
        aspect-ratio: 4/3;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #1a1a1a;
        color: #fff;
        flex-direction: column;
    }
    
    .camera-placeholder i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .controls-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .status-indicator.active {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-indicator.inactive {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .status-dot.active {
        background-color: #28a745;
        animation: pulse 2s infinite;
    }
    
    .status-dot.inactive {
        background-color: #dc3545;
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }
    
    .info-card {
        background: #e7f1ff;
        border-left: 4px solid #0d6efd;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .info-card p {
        margin-bottom: 0;
        color: #0a58ca;
    }
</style>
{% endblock %}

{% block content %}
<div class="attendance-container">
    <div class="attendance-header">
        <h1><i class="bi bi-camera-fill me-2"></i>Take Attendance</h1>
        <p>Position yourself in front of the camera for face recognition</p>
    </div>
    
    <div class="camera-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">Camera Feed</h3>
            <div class="status-indicator active" id="statusIndicator">
                <span class="status-dot active"></span>
                <span>Camera Active</span>
            </div>
        </div>
        
        <div class="camera-container">
            <img src="{{ url_for('video_feed') }}" class="camera-feed" id="cameraFeed" alt="Camera Feed">
            <div class="camera-placeholder" id="cameraPlaceholder" style="display: none;">
                <i class="bi bi-camera-video-off"></i>
                <p>Camera feed unavailable</p>
            </div>
        </div>
        
        <div class="info-card">
            <p><i class="bi bi-info-circle me-2"></i><strong>Instructions:</strong> Ensure good lighting and face the camera directly. The system will automatically detect and recognize your face.</p>
        </div>
    </div>
    
    <div class="controls-section">
        <h3 class="mb-3">Recognition Status</h3>
        <div class="alert alert-success" role="alert" id="recognitionAlert" style="display: none;">
            <i class="bi bi-check-circle me-2"></i>
            <strong id="recognitionMessage">Face recognized and attendance marked!</strong>
        </div>
        <div class="alert alert-warning" role="alert" id="unknownAlert" style="display: none;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Unknown face detected. Please ensure you are registered in the system.</strong>
        </div>
        <div class="alert alert-info" role="alert" id="infoAlert">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Instructions:</strong> Look directly at the camera. The system will automatically recognize your face and mark attendance once per day.
        </div>
        
        <div class="mt-3">
            <h5>How it works:</h5>
            <ul class="list-unstyled">
                <li><i class="bi bi-check-circle text-success me-2"></i>Green box = Face recognized</li>
                <li><i class="bi bi-x-circle text-danger me-2"></i>Red box = Unknown face</li>
                <li><i class="bi bi-calendar-check text-primary me-2"></i>Attendance marked automatically once per day</li>
                <li><i class="bi bi-shield-check text-info me-2"></i>Confidence score displayed with name</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cameraFeed = document.getElementById('cameraFeed');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const statusIndicator = document.getElementById('statusIndicator');
        
        // Handle image load error
        cameraFeed.onerror = function() {
            cameraFeed.style.display = 'none';
            cameraPlaceholder.style.display = 'flex';
            statusIndicator.classList.remove('active');
            statusIndicator.classList.add('inactive');
            statusIndicator.innerHTML = '<span class="status-dot inactive"></span><span>Camera Inactive</span>';
        };
        
        // Handle successful image load
        cameraFeed.onload = function() {
            cameraFeed.style.display = 'block';
            cameraPlaceholder.style.display = 'none';
            statusIndicator.classList.remove('inactive');
            statusIndicator.classList.add('active');
            statusIndicator.innerHTML = '<span class="status-dot active"></span><span>Camera Active</span>';
        };
        
        // Check camera feed periodically
        setInterval(function() {
            if (cameraFeed.complete && cameraFeed.naturalWidth > 0) {
                cameraFeed.onload();
            }
        }, 2000);
    });
</script>
{% endblock %}
